# MIMIC-IV å¿«é€Ÿå¼€å§‹æŒ‡å—

**é€‚ç”¨äº**: å·²å®Œæˆæ•°æ®åº“è¿æ¥é…ç½®çš„ç”¨æˆ·
**ç›®æ ‡**: 5åˆ†é’Ÿå†…å¼€å§‹æ•°æ®åˆ†æ

---

## ğŸš€ ç«‹å³å¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šæµ‹è¯•è¿æ¥ï¼ˆ30ç§’ï¼‰

```bash
cd /mnt/f/SaAki_Sofa_benchmark
conda activate rna-seq
python -c "from utils.db_helper import test_connection; test_connection('mimic')"
```

**æœŸæœ›è¾“å‡º**ï¼š
```
âœ… è¿æ¥æˆåŠŸï¼
```

---

### ç¬¬äºŒæ­¥ï¼šç¬¬ä¸€ä¸ªæŸ¥è¯¢ï¼ˆ1åˆ†é’Ÿï¼‰

**åˆ›å»ºæ–‡ä»¶**: `my_first_query.py`

```python
from utils.db_helper import query_to_df

# æŸ¥è¯¢å‰10ä¸ªæ‚£è€…
df = query_to_df("""
    SELECT * FROM mimiciv_hosp.patients LIMIT 10;
""", db='mimic')

print(df)
```

**è¿è¡Œ**ï¼š
```bash
python my_first_query.py
```

---

### ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨é¢„è®¡ç®—è¡¨ï¼ˆ2åˆ†é’Ÿï¼‰

```python
from utils.db_helper import query_to_df

# è·å–è„“æ¯’ç—‡æ‚£è€…
sepsis_df = query_to_df("""
    SELECT
        subject_id,
        stay_id,
        sofa_24hours,
        sepsis3
    FROM mimiciv_derived.sepsis3
    WHERE sepsis3 = true
    LIMIT 100;
""", db='mimic')

print(f"æ‰¾åˆ° {len(sepsis_df)} ä¸ªè„“æ¯’ç—‡æ‚£è€…")
print(sepsis_df.head())

# ä¿å­˜ç»“æœ
sepsis_df.to_csv('output/sepsis_patients.csv', index=False)
print("âœ… ç»“æœå·²ä¿å­˜åˆ° output/sepsis_patients.csv")
```

---

## ğŸ“Š å¸¸ç”¨æŸ¥è¯¢æ¨¡æ¿

### æ¨¡æ¿ 1ï¼šæ‚£è€…é˜Ÿåˆ—

```python
from utils.db_helper import query_to_df

cohort_df = query_to_df("""
    SELECT
        ie.stay_id,
        ie.subject_id,
        p.gender,
        p.anchor_age as age,
        ie.los,
        a.hospital_expire_flag as mortality
    FROM mimiciv_icu.icustays ie
    JOIN mimiciv_hosp.patients p ON ie.subject_id = p.subject_id
    JOIN mimiciv_hosp.admissions a ON ie.hadm_id = a.hadm_id
    WHERE p.anchor_age >= 18
      AND ie.los >= 1
    LIMIT 1000;
""", db='mimic')

print(f"é˜Ÿåˆ—å¤§å°: {len(cohort_df)}")
print(f"å¹³å‡å¹´é¾„: {cohort_df['age'].mean():.1f}")
print(f"æ­»äº¡ç‡: {cohort_df['mortality'].mean()*100:.1f}%")
```

---

### æ¨¡æ¿ 2ï¼šSOFA è¯„åˆ†

```python
sofa_df = query_to_df("""
    SELECT
        stay_id,
        sofa_24hours as total_sofa,
        respiration_24hours as resp,
        coagulation_24hours as coag,
        liver_24hours,
        cardiovascular_24hours as cardio,
        cns_24hours,
        renal_24hours as renal
    FROM mimiciv_derived.first_day_sofa
    WHERE sofa_24hours IS NOT NULL
    LIMIT 1000;
""", db='mimic')

# ç»Ÿè®¡åˆ†æ
print("SOFA è¯„åˆ†åˆ†å¸ƒ:")
print(sofa_df['total_sofa'].describe())

# é«˜ SOFA æ‚£è€…
high_sofa = sofa_df[sofa_df['total_sofa'] >= 10]
print(f"\nSOFA â‰¥ 10 çš„æ‚£è€…: {len(high_sofa)}")
```

---

### æ¨¡æ¿ 3ï¼šAKI æ‚£è€…

```python
aki_df = query_to_df("""
    SELECT
        stay_id,
        MAX(aki_stage) as max_aki_stage
    FROM mimiciv_derived.kdigo_stages
    WHERE aki_stage >= 1
    GROUP BY stay_id
    LIMIT 1000;
""", db='mimic')

# ç»Ÿè®¡å„é˜¶æ®µ
print("AKI åˆ†æœŸåˆ†å¸ƒ:")
print(aki_df['max_aki_stage'].value_counts().sort_index())
```

---

### æ¨¡æ¿ 4ï¼šç”Ÿå‘½ä½“å¾æ—¶é—´åºåˆ—

```python
# è·å–ä¸€ä¸ªæ‚£è€…çš„ç”Ÿå‘½ä½“å¾
sample_stay_id = 30000001  # æ›¿æ¢ä¸ºå®é™… stay_id

vitals_df = query_to_df(f"""
    SELECT
        charttime,
        heart_rate,
        sbp,
        dbp,
        mbp,
        resp_rate,
        temperature,
        spo2
    FROM mimiciv_derived.vitalsign
    WHERE stay_id = {sample_stay_id}
    ORDER BY charttime
    LIMIT 100;
""", db='mimic')

print(f"è·å–åˆ° {len(vitals_df)} æ¡ç”Ÿå‘½ä½“å¾è®°å½•")
print(vitals_df.head())
```

---

## ğŸ¯ å®ç”¨å‡½æ•°

### å¿«é€Ÿé¢„è§ˆè¡¨

```python
from utils.db_helper import preview_table

# é¢„è§ˆè¡¨çš„å‰10è¡Œ
df = preview_table('mimiciv_derived.sepsis3', db='mimic', n=10)
print(df)
```

### è·å–è¡¨ä¿¡æ¯

```python
from utils.db_helper import get_table_info

# æŸ¥çœ‹è¡¨ç»“æ„
info = get_table_info('mimiciv_derived.sepsis3', db='mimic')
print(info)
```

### å¯¼å‡ºåˆ° CSV

```python
from utils.db_helper import export_to_csv

# å¯¼å‡ºå¤§æ•°æ®é›†
export_to_csv(
    sql="""
        SELECT * FROM mimiciv_derived.sepsis3
        WHERE sepsis3 = true
    """,
    output_file='output/all_sepsis_patients.csv',
    db='mimic'
)
```

---

## ğŸ“ æ¨èçš„é¡¹ç›®ç»“æ„

```
/mnt/f/SaAki_Sofa_benchmark/
â”œâ”€â”€ data/                      # åŸå§‹æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
â”œâ”€â”€ output/                    # è¾“å‡ºç»“æœ
â”‚   â”œâ”€â”€ cohorts/              # æ‚£è€…é˜Ÿåˆ—
â”‚   â”œâ”€â”€ analysis/             # åˆ†æç»“æœ
â”‚   â””â”€â”€ figures/              # å›¾è¡¨
â”œâ”€â”€ scripts/                   # åˆ†æè„šæœ¬
â”‚   â”œâ”€â”€ 01_build_cohort.py    # æ„å»ºé˜Ÿåˆ—
â”‚   â”œâ”€â”€ 02_extract_sofa.py    # æå– SOFA
â”‚   â”œâ”€â”€ 03_identify_aki.py    # è¯†åˆ« AKI
â”‚   â””â”€â”€ 04_analysis.py        # ç»Ÿè®¡åˆ†æ
â”œâ”€â”€ notebooks/                 # Jupyter notebooks
â””â”€â”€ docs/                      # æ–‡æ¡£
```

---

## ğŸ’¡ å¸¸è§ä»»åŠ¡

### ä»»åŠ¡ 1ï¼šæ„å»ºè„“æ¯’ç—‡é˜Ÿåˆ—

```python
"""
æ„å»ºè„“æ¯’ç—‡æ‚£è€…é˜Ÿåˆ—ï¼ŒåŒ…å«äººå£ç»Ÿè®¡å­¦å’Œç»“å±€
"""
from utils.db_helper import query_to_df

sepsis_cohort = query_to_df("""
    SELECT
        s.subject_id,
        s.hadm_id,
        s.stay_id,
        p.gender,
        p.anchor_age as age,
        a.race,
        a.admission_type,
        ie.intime,
        ie.outtime,
        ie.los,
        a.hospital_expire_flag as mortality,
        s.sofa_24hours,
        s.sepsis3
    FROM mimiciv_derived.sepsis3 s
    JOIN mimiciv_hosp.patients p ON s.subject_id = p.subject_id
    JOIN mimiciv_hosp.admissions a ON s.hadm_id = a.hadm_id
    JOIN mimiciv_icu.icustays ie ON s.stay_id = ie.stay_id
    WHERE s.sepsis3 = true
      AND p.anchor_age >= 18
""", db='mimic')

print(f"è„“æ¯’ç—‡é˜Ÿåˆ—: {len(sepsis_cohort)} æ‚£è€…")

# ä¿å­˜
sepsis_cohort.to_csv('output/cohorts/sepsis_cohort.csv', index=False)
print("âœ… é˜Ÿåˆ—å·²ä¿å­˜")
```

---

### ä»»åŠ¡ 2ï¼šæå–å®éªŒå®¤å€¼

```python
"""
æå–é˜Ÿåˆ—çš„é¦–æ—¥å®éªŒå®¤å€¼
"""
# å…ˆè·å–é˜Ÿåˆ—çš„ stay_id
stay_ids = sepsis_cohort['stay_id'].tolist()
stay_ids_str = ','.join(map(str, stay_ids[:1000]))  # å…ˆæµ‹è¯•1000ä¸ª

labs = query_to_df(f"""
    SELECT
        stay_id,
        glucose_max,
        glucose_min,
        potassium_max,
        potassium_min,
        sodium_max,
        sodium_min,
        hematocrit_max,
        hematocrit_min,
        wbc_max,
        wbc_min,
        creatinine_max,
        creatinine_min
    FROM mimiciv_derived.first_day_lab
    WHERE stay_id IN ({stay_ids_str})
""", db='mimic')

print(f"æå–äº† {len(labs)} ä¸ªæ‚£è€…çš„å®éªŒå®¤å€¼")
```

---

### ä»»åŠ¡ 3ï¼šåˆ†æ SOFA å„ç»„åˆ†

```python
import pandas as pd
import matplotlib.pyplot as plt

sofa = query_to_df(f"""
    SELECT * FROM mimiciv_derived.first_day_sofa
    WHERE stay_id IN ({stay_ids_str})
""", db='mimic')

# è®¡ç®—å„ç»„åˆ†çš„å¹³å‡åˆ†
components = ['respiration_24hours', 'coagulation_24hours',
              'liver_24hours', 'cardiovascular_24hours',
              'cns_24hours', 'renal_24hours']

means = sofa[components].mean()

# ç»˜å›¾
plt.figure(figsize=(10, 6))
means.plot(kind='bar')
plt.title('SOFA å„ç»„åˆ†å¹³å‡åˆ†')
plt.ylabel('å¹³å‡åˆ†')
plt.xticks(rotation=45)
plt.tight_layout()
plt.savefig('output/figures/sofa_components.png', dpi=300)
print("âœ… å›¾è¡¨å·²ä¿å­˜")
```

---

## âš¡ æ€§èƒ½æç¤º

### 1. ä½¿ç”¨ LIMIT æµ‹è¯•

```python
# å…ˆç”¨å°æ•°æ®é›†æµ‹è¯•
df = query_to_df(sql + " LIMIT 100", db='mimic')

# ç¡®è®¤æ— è¯¯åå†è¿è¡Œå…¨éƒ¨
df_full = query_to_df(sql, db='mimic')
```

### 2. ä½¿ç”¨é¢„è®¡ç®—è¡¨

```python
# âŒ æ…¢ - ä»åŸå§‹æ•°æ®è®¡ç®—
# SELECT ... FROM mimiciv_icu.chartevents ...

# âœ… å¿« - ä½¿ç”¨é¢„è®¡ç®—è¡¨
# SELECT ... FROM mimiciv_derived.vitalsign ...
```

### 3. åˆ†æ‰¹å¤„ç†å¤§æ•°æ®

```python
# å¯¹äºå¤§é˜Ÿåˆ—ï¼Œåˆ†æ‰¹æŸ¥è¯¢
batch_size = 1000
for i in range(0, len(stay_ids), batch_size):
    batch = stay_ids[i:i+batch_size]
    # å¤„ç†è¿™ä¸€æ‰¹...
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æ£€æŸ¥æŸ¥è¯¢ç»“æœ

```python
df = query_to_df(sql, db='mimic')

# åŸºæœ¬æ£€æŸ¥
print(f"è¡Œæ•°: {len(df)}")
print(f"åˆ—æ•°: {len(df.columns)}")
print(f"åˆ—å: {df.columns.tolist()}")
print(f"æ•°æ®ç±»å‹:\n{df.dtypes}")
print(f"ç¼ºå¤±å€¼:\n{df.isnull().sum()}")
print(f"\nå‰5è¡Œ:\n{df.head()}")
```

### æŸ¥çœ‹ SQL è¯­å¥

```python
# æ‰“å° SQL ä»¥æ£€æŸ¥
sql = """
    SELECT * FROM mimiciv_derived.sepsis3
    WHERE sepsis3 = true
"""
print("æ‰§è¡Œçš„ SQL:")
print(sql)

df = query_to_df(sql, db='mimic')
```

---

## ğŸ“š å­¦ä¹ èµ„æº

### MIMIC-IV æŠ€èƒ½æ–‡æ¡£

```bash
# æŸ¥çœ‹å®Œæ•´æŠ€èƒ½ï¼ˆåŒ…å«æ‰€æœ‰ SQL æ¨¡å¼ï¼‰
cat .claude/skills/mimiciv-data-extraction/SKILL.md

# æŸ¥çœ‹å¿«é€ŸæŒ‡å—
cat .claude/skills/mimiciv-data-extraction/README.md
```

### æ•°æ®åº“æ‘˜è¦

```bash
# æŸ¥çœ‹æ•°æ®åº“ç»“æ„å’Œç»Ÿè®¡
cat MIMICIV_Database_Summary.md
```

### ç¤ºä¾‹è„šæœ¬

```bash
# æŸ¥çœ‹ç°æœ‰ç¤ºä¾‹
ls examples/
python examples/quick_query_example.py
```

---

## ğŸ“ ä¸‹ä¸€æ­¥å­¦ä¹ 

1. **ç†Ÿæ‚‰é¢„è®¡ç®—è¡¨**
   - æµè§ˆ `mimiciv_derived` schema
   - äº†è§£å¯ç”¨çš„ä¸´åºŠæ¦‚å¿µ

2. **å­¦ä¹  ItemID**
   - æŸ¥çœ‹ SKILL.md ä¸­çš„ itemid å‚è€ƒ
   - äº†è§£å¦‚ä½•æŸ¥è¯¢ç”Ÿå‘½ä½“å¾å’Œå®éªŒå®¤å€¼

3. **æ„å»ºè‡ªå·±çš„é˜Ÿåˆ—**
   - å®šä¹‰çº³å…¥/æ’é™¤æ ‡å‡†
   - ç»„åˆå¤šä¸ªè¡¨

4. **é«˜çº§åˆ†æ**
   - æ—¶é—´åºåˆ—åˆ†æ
   - é¢„åé¢„æµ‹
   - äºšç»„åˆ†æ

---

## ğŸ’¬ è·å–å¸®åŠ©

### ä½¿ç”¨ Claude Code

åœ¨å¯¹è¯ä¸­æé—®ï¼š
```
"ä½¿ç”¨ MIMIC-IV æŠ€èƒ½ï¼Œå¸®æˆ‘æå–è„“æ¯’ç—‡æ‚£è€…çš„é¦–æ—¥ SOFA è¯„åˆ†"

"å¦‚ä½•ä» chartevents è¡¨ä¸­æå–å¿ƒç‡æ•°æ®ï¼Ÿå‚è€ƒ MIMIC-IV æŠ€èƒ½"

"æ ¹æ® MIMIC-IV æŠ€èƒ½ï¼Œæ„å»ºä¸€ä¸ªåŒ…å« AKI ä¿¡æ¯çš„æ‚£è€…é˜Ÿåˆ—"
```

### æŸ¥çœ‹æ–‡æ¡£

- å®Œæ•´æµç¨‹æ–‡æ¡£ï¼š`docs/å®Œæ•´æµç¨‹æ–‡æ¡£/01_å®Œæ•´æµç¨‹æ€»ç»“.md`
- æ•°æ®åº“æ‘˜è¦ï¼š`MIMICIV_Database_Summary.md`
- æŠ€èƒ½æ–‡æ¡£ï¼š`.claude/skills/mimiciv-data-extraction/SKILL.md`

---

**ç¥ç ”ç©¶é¡ºåˆ©ï¼** ğŸš€
